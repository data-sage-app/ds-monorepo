{{ config(schema='ods') }}

WITH latest_orders AS (
    SELECT 
        id,
        ds_shopify_prefix,
        ds_clerk_org_id,
        ds_row_date,
        shopify_data->>'id' AS shopify_id,
        shopify_data->'customer'->>'id' as shopify_customer_id,
        shopify_data->>'admin_graphql_api_id' as admin_graphql_api_id,
        shopify_data->>'browser_ip' as browser_ip,
        shopify_data->>'buyer_accepts_marketing' as buyer_accepts_marketing,
        shopify_data->>'cancel_reason' as cancel_reason,
        shopify_data->>'cancelled_at' as cancelled_at,
        shopify_data->>'cart_token' as cart_token,
        shopify_data->>'checkout_id' as checkout_id,
        shopify_data->>'checkout_token' as checkout_token,
        shopify_data->'client_details'->>'accept_language' as client_accept_language,
        shopify_data->'client_details'->>'browser_height' as client_browser_height,
        shopify_data->'client_details'->>'browser_ip' as client_browser_ip,
        shopify_data->'client_details'->>'browser_width' as client_browser_width,
        shopify_data->'client_details'->>'session_hash' as client_session_hash,
        shopify_data->'client_details'->>'user_agent' as client_user_agent,
        shopify_data->>'closed_at' as closed_at,
        shopify_data->>'confirmed' as confirmed,
        shopify_data->>'contact_email' as contact_email,
        CAST(shopify_data->>'created_at' AS DATE) as created_at,
        shopify_data->>'currency' as currency,
        shopify_data->>'current_subtotal_price' as current_subtotal_price,
        shopify_data->'current_subtotal_price_set'->'shop_money'->>'amount' as current_subtotal_price_shop_money_amount,
        shopify_data->'current_subtotal_price_set'->'shop_money'->>'currency_code' as current_subtotal_price_shop_money_currency_code,
        shopify_data->'current_subtotal_price_set'->'presentment_money'->>'amount' as current_subtotal_price_presentment_money_amount,
        shopify_data->'current_subtotal_price_set'->'presentment_money'->>'currency_code' as current_subtotal_price_presentment_money_currency_code,
        shopify_data->>'current_total_discounts' as current_total_discounts,
        shopify_data->'current_total_discounts_set'->'shop_money'->>'amount' as current_total_discounts_shop_money_amount,
        shopify_data->'current_total_discounts_set'->'shop_money'->>'currency_code' as current_total_discounts_shop_money_currency_code,
        shopify_data->'current_total_discounts_set'->'presentment_money'->>'amount' as current_total_discounts_presentment_money_amount,
        shopify_data->'current_total_discounts_set'->'presentment_money'->>'currency_code' as current_total_discounts_presentment_money_currency_code,
        shopify_data->>'current_total_price' as current_total_price,
        shopify_data->'current_total_price_set'->'shop_money'->>'amount' as current_total_price_shop_money_amount,
        shopify_data->'current_total_price_set'->'shop_money'->>'currency_code' as current_total_price_shop_money_currency_code,
        shopify_data->'current_total_price_set'->'presentment_money'->>'amount' as current_total_price_presentment_money_amount,
        shopify_data->'current_total_price_set'->'presentment_money'->>'currency_code' as current_total_price_presentment_money_currency_code,
        shopify_data->>'current_total_tax' as current_total_tax,
        shopify_data->'current_total_tax_set'->'shop_money'->>'amount' as current_total_tax_shop_money_amount,
        shopify_data->'current_total_tax_set'->'shop_money'->>'currency_code' as current_total_tax_shop_money_currency_code,
        shopify_data->'current_total_tax_set'->'presentment_money'->>'amount' as current_total_tax_presentment_money_amount,
        shopify_data->'current_total_tax_set'->'presentment_money'->>'currency_code' as current_total_tax_presentment_money_currency_code,
        shopify_data->>'customer_locale' as customer_locale,
        shopify_data->>'device_id' as device_id,
        shopify_data->>'email' as email,
        shopify_data->>'estimated_taxes' as estimated_taxes,
        shopify_data->>'financial_status' as financial_status,
        shopify_data->>'fulfillment_status' as fulfillment_status,
        shopify_data->>'gateway' as gateway,
        shopify_data->>'landing_site' as landing_site,
        shopify_data->>'landing_site_ref' as landing_site_ref,
        shopify_data->>'location_id' as location_id,
        shopify_data->>'name' as name,
        shopify_data->>'note' as note,
        shopify_data->>'number' as number,
        shopify_data->>'order_number' as order_number,
        shopify_data->>'order_status_url' as order_status_url,
        shopify_data->>'phone' as phone,
        shopify_data->>'presentment_currency' as presentment_currency,
        shopify_data->>'processed_at' as processed_at,
        shopify_data->>'processing_method' as processing_method,
        shopify_data->>'reference' as reference,
        shopify_data->>'referring_site' as referring_site,
        shopify_data->>'source_identifier' as source_identifier,
        shopify_data->>'source_name' as source_name,
        shopify_data->>'source_url' as source_url,
        shopify_data->>'subtotal_price' as subtotal_price,
        shopify_data->'subtotal_price_set'->'shop_money'->>'amount' as subtotal_price_shop_money_amount,
        shopify_data->'subtotal_price_set'->'shop_money'->>'currency_code' as subtotal_price_shop_money_currency_code,
        shopify_data->'subtotal_price_set'->'presentment_money'->>'amount' as subtotal_price_presentment_money_amount,
        shopify_data->'subtotal_price_set'->'presentment_money'->>'currency_code' as subtotal_price_presentment_money_currency_code,
        shopify_data->>'tags' as tags,
        shopify_data->>'taxes_included' as taxes_included,
        shopify_data->>'test' as test,
        shopify_data->>'token' as token,
        shopify_data->>'total_discounts' as total_discounts,
        shopify_data->'total_discounts_set'->'shop_money'->>'amount' as total_discounts_shop_money_amount,
        shopify_data->'total_discounts_set'->'shop_money'->>'currency_code' as total_discounts_shop_money_currency_code,
        shopify_data->'total_discounts_set'->'presentment_money'->>'amount' as total_discounts_presentment_money_amount,
        shopify_data->'total_discounts_set'->'presentment_money'->>'currency_code' as total_discounts_presentment_money_currency_code,
        shopify_data->>'total_line_items_price' as total_line_items_price,
        shopify_data->'total_line_items_price_set'->'shop_money'->>'amount' as total_line_items_price_shop_money_amount,
        shopify_data->'total_line_items_price_set'->'shop_money'->>'currency_code' as total_line_items_price_shop_money_currency_code,
        shopify_data->'total_line_items_price_set'->'presentment_money'->>'amount' as total_line_items_price_presentment_money_amount,
        shopify_data->'total_line_items_price_set'->'presentment_money'->>'currency_code' as total_line_items_price_presentment_money_currency_code,
        shopify_data->>'total_outstanding' as total_outstanding,
        CAST(shopify_data->>'total_price' AS FLOAT) AS total_price,
        shopify_data->'total_price_set'->'shop_money'->>'amount' as total_price_shop_money_amount,
        shopify_data->'total_price_set'->'shop_money'->>'currency_code' as total_price_shop_money_currency_code,
        shopify_data->'total_price_set'->'presentment_money'->>'amount' as total_price_presentment_money_amount,
        shopify_data->'total_price_set'->'presentment_money'->>'currency_code' as total_price_presentment_money_currency_code,
        shopify_data->>'total_price_usd' as total_price_usd,
        shopify_data->'total_shipping_price_set'->'shop_money'->>'amount' as total_shipping_price_shop_money_amount,
        shopify_data->'total_shipping_price_set'->'shop_money'->>'currency_code' as total_shipping_price_shop_money_currency_code,
        shopify_data->'total_shipping_price_set'->'presentment_money'->>'amount' as total_shipping_price_presentment_money_amount,
        shopify_data->'total_shipping_price_set'->'presentment_money'->>'currency_code' as total_shipping_price_presentment_money_currency_code,
        shopify_data->>'total_tax' as total_tax,
        shopify_data->'total_tax_set'->'shop_money'->>'amount' as total_tax_shop_money_amount,
        shopify_data->'total_tax_set'->'shop_money'->>'currency_code' as total_tax_shop_money_currency_code,
        shopify_data->'total_tax_set'->'presentment_money'->>'amount' as total_tax_presentment_money_amount,
        shopify_data->'total_tax_set'->'presentment_money'->>'currency_code' as total_tax_presentment_money_currency_code,
        shopify_data->>'total_tip_received' as total_tip_received,
        shopify_data->>'total_weight' as total_weight,
        CAST(shopify_data->>'updated_at' AS DATE) as updated_at,
        shopify_data->>'user_id' as user_id,
        shopify_data->'billing_address'->>'first_name' as billing_address_first_name,
        shopify_data->'billing_address'->>'address1' as billing_address_address1,
        shopify_data->'billing_address'->>'phone' as billing_address_phone,
        shopify_data->'billing_address'->>'city' as billing_address_city,
        shopify_data->'billing_address'->>'zip' as billing_address_zip,
        shopify_data->'billing_address'->>'province' as billing_address_province,
        shopify_data->'billing_address'->>'country' as billing_address_country,
        shopify_data->'billing_address'->>'last_name' as billing_address_last_name,
        shopify_data->'billing_address'->>'address2' as billing_address_address2,
        shopify_data->'billing_address'->>'company' as billing_address_company,
        shopify_data->'billing_address'->>'latitude' as billing_address_latitude,
        shopify_data->'billing_address'->>'longitude' as billing_address_longitude,
        shopify_data->'billing_address'->>'name' as billing_address_name,
        shopify_data->'billing_address'->>'country_code' as billing_address_country_code,
        shopify_data->'billing_address'->>'province_code' as billing_address_province_code,
        shopify_data->'customer'->>'email' as customer_email,
        shopify_data->'customer'->>'accepts_marketing' as customer_accepts_marketing,
        shopify_data->'customer'->>'created_at' as customer_created_at,
        shopify_data->'customer'->>'updated_at' as customer_updated_at,
        shopify_data->'customer'->>'first_name' as customer_first_name,
        shopify_data->'customer'->>'last_name' as customer_last_name,
        shopify_data->'customer'->>'orders_count' as customer_orders_count,
        shopify_data->'customer'->>'state' as customer_state,
        shopify_data->'customer'->>'total_spent' as customer_total_spent,
        shopify_data->'customer'->>'last_order_id' as customer_last_order_id,
        shopify_data->'customer'->>'note' as customer_note,
        shopify_data->'customer'->>'verified_email' as customer_verified_email,
        shopify_data->'customer'->>'multipass_identifier' as customer_multipass_identifier,
        shopify_data->'customer'->>'tax_exempt' as customer_tax_exempt,
        shopify_data->'customer'->>'phone' as customer_phone,
        shopify_data->'customer'->>'tags' as customer_tags,
        shopify_data->'customer'->>'currency' as customer_currency,
        shopify_data->'customer'->>'last_order_name' as customer_last_order_name,
        shopify_data->'customer'->>'accepts_marketing_updated_at' as customer_accepts_marketing_updated_at,
        shopify_data->'customer'->>'marketing_opt_in_level' as customer_marketing_opt_in_level,
        shopify_data->'customer'->>'admin_graphql_api_id' as customer_admin_graphql_api_id,
        shopify_data->'customer'->'default_address'->>'id' as customer_default_address_id,
        shopify_data->'customer'->'default_address'->>'customer_id' as customer_default_address_customer_id,
        shopify_data->'customer'->'default_address'->>'first_name' as customer_default_address_first_name,
        shopify_data->'customer'->'default_address'->>'last_name' as customer_default_address_last_name,
        shopify_data->'customer'->'default_address'->>'company' as customer_default_address_company,
        shopify_data->'customer'->'default_address'->>'address1' as customer_default_address_address1,
        shopify_data->'customer'->'default_address'->>'address2' as customer_default_address_address2,
        shopify_data->'customer'->'default_address'->>'city' as customer_default_address_city,
        shopify_data->'customer'->'default_address'->>'province' as customer_default_address_province,
        shopify_data->'customer'->'default_address'->>'country' as customer_default_address_country,
        shopify_data->'customer'->'default_address'->>'zip' as customer_default_address_zip,
        shopify_data->'customer'->'default_address'->>'phone' as customer_default_address_phone,
        shopify_data->'customer'->'default_address'->>'name' as customer_default_address_name,
        shopify_data->'customer'->'default_address'->>'province_code' as customer_default_address_province_code,
        shopify_data->'customer'->'default_address'->>'country_code' as customer_default_address_country_code,
        shopify_data->'customer'->'default_address'->>'country_name' as customer_default_address_country_name,
        shopify_data->'customer'->'default_address'->>'default' as customer_default_address_default,
        shopify_data->'payment_details'->>'credit_card_bin' as payment_details_credit_card_bin,
        shopify_data->'payment_details'->>'avs_result_code' as payment_details_avs_result_code,
        shopify_data->'payment_details'->>'cvv_result_code' as payment_details_cvv_result_code,
        shopify_data->'payment_details'->>'credit_card_number' as payment_details_credit_card_number,
        shopify_data->'payment_details'->>'credit_card_company' as payment_details_credit_card_company,
        shopify_data->'payment_terms' as payment_terms,
        shopify_data->'shipping_address'->>'first_name' as shipping_address_first_name,
        shopify_data->'shipping_address'->>'address1' as shipping_address_address1,
        shopify_data->'shipping_address'->>'phone' as shipping_address_phone,
        shopify_data->'shipping_address'->>'city' as shipping_address_city,
        shopify_data->'shipping_address'->>'zip' as shipping_address_zip,
        shopify_data->'shipping_address'->>'province' as shipping_address_province,
        shopify_data->'shipping_address'->>'country' as shipping_address_country,
        shopify_data->'shipping_address'->>'last_name' as shipping_address_last_name,
        shopify_data->'shipping_address'->>'address2' as shipping_address_address2,
        shopify_data->'shipping_address'->>'company' as shipping_address_company,
        shopify_data->'shipping_address'->>'latitude' as shipping_address_latitude,
        shopify_data->'shipping_address'->>'longitude' as shipping_address_longitude,
        shopify_data->'shipping_address'->>'name' as shipping_address_name,
        shopify_data->'shipping_address'->>'country_code' as shipping_address_country_code,
        shopify_data->'shipping_address'->>'province_code' as shipping_address_province_code,
        ROW_NUMBER() OVER (PARTITION BY shopify_data->>'id' ORDER BY ds_row_date DESC) AS rn
    FROM landing.shopify
    WHERE shopify_resource = 'orders'
)

SELECT *
FROM latest_orders
WHERE rn = 1